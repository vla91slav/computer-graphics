<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лабораторная работа №2 вариант 7</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
      <div class="container-1">
        <div class="canvas-buttons">
            <div class="fast-moves">
                <p class="moves">Быстрые действия:</p>
                <button id="zoomin" class="nav" title="Приблизить" onclick="zoomIn()">&#43;</button>
                <button id="zoomout" class="nav" title="Отдалить" onclick="zoomOut()">&#8722;</button>
                <button id="panup" class="nav" title="Сместить вверх" onclick="panUp(25)">&#8679;</button>
                <button id="pandown" class="nav" title="Сместить вниз" onclick="panDown(25)">&#8681;</button>
                <button id="panleft" class="nav" title="Сместить влево" onclick="panLeft(25)">&#8678;</button>
                <button id="panright" class="nav" title="Сместить вправо" onclick="panRight(25)">&#8680;</button>
                <button id="rotateleft" class="nav" title="Повернуть влево на 90 градусов" onclick="rotate(-90, save=1)">&#10553;</button>
                <button id="rotateright" class="nav" title="Повернуть вправо на 90 градусов" onclick="rotate(90, save=1)">&#10552;</button>
                <button id="reset" class="nav" title="Сброс" onclick="reset()">&#8634;</button>
            </div>
            <div class="wrapper">
                <canvas id="canvas" width="800" height="850"></canvas>
                <canvas id="canvasX" width="800" height="850"></canvas>
            </div>
        </div>

          <div class="input-block">
            <div class="input-1">
                <label class="label-1">Смещение по x</label>
                <label class="label-1">Смещение по y</label>
                <br>
                <input type="text" id="xmove" onclick="this.select();" placeholder="пример: 4">
                <input type="text" id="ymove" onclick="this.select();" placeholder="пример: 2.5">
                <br>
                <button id="move">Переместить</button>
            </div>
            <br>
            <div class="input-2">
                <label class="label-2">Угол поворота (в градусах)</label>
                <br>
                <input type="text" id="rotate" onclick="this.select();" placeholder="пример: 90">
                <button id="rotatebtn">Повернуть</button>
            </div>
            <br>
            <div class="input-3">
                <label class="label-3">Центр рисунка</label>
                <br>
                <label class="label-4">x</label>
                <label class="label-4">y</label>
                <br>
                <input type="text" id="xcenter" onclick="this.select();" placeholder="пример: 4">
                <input type="text" id="ycenter" onclick="this.select();" placeholder="пример: 2.5">
                <br>
                <button id="centerupdate">Обновить центр рисунка</button>
            </div>
            <br>
            <div class="input-4">
                <label class="label-5">Масштабирование по x</label>
                <label class="label-5">Масштабирование по y</label>
                <br>
                <input type="text" id="xscale" onclick="this.select();" placeholder="пример: 4">
                <input type="text" id="yscale" onclick="this.select();" placeholder="пример: 2.5">
                <br>
                <button id="scale">Масштабировать</button>
            </div>
          </div>
      </div>
    <div><button id="window" hidden>new window</button></div>
</body>
<script>
    require('./js/renderer.js')
</script>
<script>
    let canvas = document.getElementById("canvas")
    let ctx = canvas.getContext("2d")
    let canvas1 = document.getElementById("canvasX")
    let ctxX = canvas1.getContext("2d")
    let statuses = []

    let cw = canvas.width
    let ch = canvas.height
    let panX = 0
    let panY = 0
    let scaleFactorX = 1.00
    let scaleFactorY = 1.00
    let radius = 62
    let fastRotate = 0

    function saveStatus() {
        statuses.push({
            panX: panX,
            panY: panY,
            scaleFactorX: scaleFactorX,
            scaleFactorY: scaleFactorY,
            fastRotate: fastRotate
        })
    }

    function toRad(n) {
        return n * Math.PI / 180
    }

    function rotate(degree, save=0) {
        if (save) saveStatus()
        fastRotate = fastRotate + toRad(degree)
        drawTranslated()
    }

    function reset() {
        saveStatus()
        document.getElementById("reset").click(); {
            panX = 0
            panY = 0
            scaleFactorX = 1.00
            scaleFactorY = 1.00
            radius = 62
            fastRotate = 0
            drawTranslated()
        }
    }

    function zoomIn(n=1.1, m=1.1) {
        document.getElementById("zoomin").click(); {
            saveStatus()
            scaleFactorX *= n
            scaleFactorY *= m
            drawTranslated()
        }
    }

    function zoomOut(n=1.1, m=1.1) {
        document.getElementById("zoomout").click(); {
            saveStatus()
            scaleFactorX /= n
            scaleFactorY /= m
            drawTranslated()
        }
    }

    function zoom(x, y) {
        scaleFactorX = x > 0 ? scaleFactorX * x : scaleFactorX / -x
        scaleFactorY = y > 0 ? scaleFactorY * y : scaleFactorY / -y
        drawTranslated()
    }

    function panUp(n, save=1) {
        if (save) saveStatus()
        panY -= n
        drawTranslated()
    }

    function panDown(n, save=1) {
        if (save) saveStatus()
        panY += n
        drawTranslated()
    }

    function panLeft(n, save=1) {
        if (save) saveStatus()
        panX -= n
        drawTranslated()
    }

    function panRight(n, save=1) {
        if (save) saveStatus()
        panX += n
        drawTranslated()
    }

    function drawTranslated() {
        // canvas
        ctx.clearRect(0, 0, cw, ch)
        ctx.save()
        ctx.translate(cw / 2, ch / 2)
        ctx.scale(scaleFactorX, scaleFactorY)
        ctx.translate(panX, panY)
        if (fastRotate) ctx.rotate(fastRotate)  // поворот через быстрые действия

        // фигура
        ctx.beginPath();
        let x = 0
        let y = 0
        const pi = Math.PI
        ctx.arc(x, y, 90, pi/4, pi-pi/4, true) // внутренняя окружность
        ctx.moveTo(x + 100, y)
        ctx.arc(x, y, 100, 0, pi, true) // внешняя окружность
        ctx.moveTo(x - 100, y)
        ctx.lineTo(x - 100, y + 120)
        ctx.lineTo(x + 100, y + 120)
        ctx.lineTo(x + 100, y)

        // хорда
        ctx.moveTo(90 * Math.cos(pi/4), 90 * Math.sin(pi-pi/4))
        ctx.lineTo(x - 90 * Math.cos(pi/4), 90 * Math.sin(pi-pi/4))

        // треугольник
        ctx.moveTo(x + 90, y + 110)
        ctx.lineTo(x + 50, y + 110)
        ctx.lineTo(x + 90, y + 70)
        ctx.lineTo(x + 90, y + 110)

        // кнопка сверху
        ctx.moveTo(100 * Math.cos(pi/2 - pi/10), 100 * Math.sin(pi + (pi/2 - pi/10)))
        ctx.lineTo(100 * Math.cos(pi/2 - pi/10), 100 * Math.sin(pi + (pi/2 - pi/10)) - 16)
        ctx.lineTo(100 * Math.cos(-pi/2 - pi/10), 100 * Math.sin(pi + (pi/2 - pi/10)) - 16)
        ctx.lineTo(100 * Math.cos(-pi/2 - pi/10), 100 * Math.sin(pi + (pi/2 - pi/10)))

        // подставка
        ctx.moveTo(x - 100, y + 140)
        ctx.lineTo(x + 100, y + 140)
        ctx.lineTo(x + 100, y + 220)
        ctx.lineTo(x - 100, y + 220)
        ctx.lineTo(x - 100, y + 140)

        // текстура подставки
        for (let i = 0; i < 200; i += 8) {
            ctx.moveTo((x - 100) + i, y + 140)
            ctx.lineTo((x - 100) + i, y + 220)
        }
        for (let i = 1.6; i < 32; i *= 2) {
            ctx.moveTo((x - 100) + i, y + 140)
            ctx.lineTo((x - 100) + i, y + 220)
        }
        for (let i = 1.6; i < 32; i *= 2) {
            ctx.moveTo((x + 100) - i, y + 140)
            ctx.lineTo((x + 100) - i, y + 220)
        }

        ctx.moveTo(x - 30, y + 140)
        ctx.lineTo(x - 30, y + 170)
        ctx.lineTo(x + 30, y + 170)
        ctx.lineTo(x + 30, y + 140)
        for (let i = 0; i < 60; i += 6) {
            ctx.moveTo((x - 30) + i, y + 140)
            ctx.lineTo((x - 30) + i, y + 170)
        }

        ctx.moveTo(x - 70, y + 220)
        ctx.lineTo(x - 70, y + 210)
        ctx.lineTo(x + 70, y + 210)
        ctx.lineTo(x + 70, y + 220)
        ctx.stroke() // контур всех проведенных линий

        // стрелки + циферблат
        ctx.clearRect(-radius, -radius, radius * 2, radius * 2)
        drawMarkers()
        drawHands()

        ctx.restore()

        // // canvasX
        // ctxX.clearRect(0, 0, cw, ch)
        // ctxX.save()
        // ctxX.translate(cw / 2, ch / 2)
        // ctxX.beginPath()

        // ctxX.moveTo(0, 25)
        // ctxX.lineTo(0, -25)
        // ctxX.moveTo(-25, 0)
        // ctxX.lineTo(25, 0)

        // ctxX.closePath()
        // ctxX.lineWidth = 1
        // ctxX.strokeStyle = 'Black'
        // ctxX.stroke()
        // ctxX.restore()
    }

    function drawMarkers() {
        let ang
        let num
        ctx.font = radius * 0.15 + "px arial"
        ctx.textBaseline = "middle"
        ctx.textAlign = "center"
        for (num = 1; num <= 12; num++) {
            ang = num * Math.PI / 6
            ctx.rotate(ang)
            ctx.translate(0, -radius * 0.85)
            ctx.rotate(-ang)
            ctx.fillText(num.toString(), 0, 0)
            ctx.rotate(ang)
            ctx.translate(0, radius * 0.85)
            ctx.rotate(-ang)
        }
    }

    function drawHands() {
        let now = new Date()
        let hour = now.getHours()
        let minute = now.getMinutes()
        let second = now.getSeconds()

        // часовая стрелка
        hour = hour % 12
        hour = (hour * Math.PI / 6) + 
            (minute * Math.PI / (6 * 60)) +
            (second * Math.PI / (360 * 60))
        drawHand(hour, radius * 0.5, radius * 0.07)

        // минутная стрелка
        minute = (minute * Math.PI / 30) + (second * Math.PI / (30 * 60))
        drawHand(minute, radius * 0.8, radius * 0.07)

        // секундная стрелка
        second = (second * Math.PI / 30)
        drawHand(second, radius * 0.9, radius * 0.02)
    }

    // отрисовка стрелок
    function drawHand(pos, length, width) {
        ctx.beginPath()
        ctx.lineWidth = width
        ctx.lineCap = "round"
        ctx.moveTo(0,0)
        ctx.rotate(pos)
        ctx.lineTo(0, -length)
        ctx.stroke()
        ctx.rotate(-pos)
    }

    setInterval(function() {
        drawTranslated()
    })

    function isNumeric(str) {
        if (typeof str != "string") return false 
        return !isNaN(str)
    }

    const moveBtn = document.getElementById('move')
    const rotateBtn = document.getElementById('rotatebtn')
    const updBtn = document.getElementById('centerupdate')
    const scaleBtn = document.getElementById('scale')

    const moveX = document.getElementById('xmove')
    const moveY = document.getElementById('ymove')

    const angle = document.getElementById('rotate')

    const centerX = document.getElementById('xcenter')
    const centerY = document.getElementById('ycenter')

    const scaleX = document.getElementById('xscale')
    const scaleY = document.getElementById('yscale')

    moveBtn.addEventListener('click', () => {
        saveStatus()
        let xm = moveX.value
        let ym = moveY.value
        if (!isNumeric(xm) || !isNumeric(ym) || xm == '' || ym == '') {
            moveX.value = ''
            moveY.value = ''
            alert('Некорректный ввод координат')
            return
        }
        xm = parseFloat(xm)
        ym = parseFloat(ym)

        if (xm > 0) panRight(xm, save=0)
        else panLeft(n=xm, save=0)

        if (ym > 0) panUp(ym, save=0)
        else panDown(n=ym, save=0)
    })

    rotateBtn.addEventListener('click', () => {
        saveStatus()
        let a = angle.value
        if (!isNumeric(a) || a == '') {
            angle.value = ''
            alert('Некорректный ввод угла')
            return
        }
        a = parseFloat(a)
        rotate(a)
    })

    updBtn.addEventListener('click', () => {
        saveStatus()
        let xm = centerX.value
        let ym = centerY.value
        if (!isNumeric(xm) || !isNumeric(ym) || xm == '' || ym == '') {
            centerX.value = ''
            centerY.value = ''
            alert('Некорректный ввод координат')
            return
        }
        xm = parseFloat(xm)
        ym = parseFloat(ym)
        x = xm
        y = ym

        panX = xm
        panY = -ym
        drawTranslated()
    })

    scaleBtn.addEventListener('click', () => {
        saveStatus()
        let xm = scaleX.value
        let ym = scaleY.value
        if (!isNumeric(xm) || !isNumeric(ym) || xm == '' || ym == '') {
            scaleX.value = ''
            scaleY.value = ''
            alert('Некорректный ввод')
            return
        }
        xm = parseFloat(xm)
        ym = parseFloat(ym)
        zoom(xm, ym)
    })

    document.addEventListener('keydown', (event) => {
        if ((event.ctrlKey || event.metaKey) && event.key === 'z') {
            let len = statuses.length
            if (len == 0) return
            let status = statuses[len - 1]
            console.log('status', status)
            panX = status.panX
            panY = status.panY
            scaleFactorX = status.scaleFactorX
            scaleFactorY = status.scaleFactorY
            fastRotate = status.fastRotate
            statuses.pop()
            drawTranslated()
        }
    })
</script>
</html>